---
import { type CollectionEntry } from "astro:content";
import { Fragment } from "astro/jsx-runtime";
import Card from "../../base/card.astro";
import { formatDate } from "../../../shared/utils";
import { marked } from "marked";
import Separator from "../../base/separator.astro";
import type { FileFromAPI } from "../../../shared/type/file-from-api";
import sanitizeHtml from "sanitize-html";
import truncate from 'html-truncate';

type Props = {
  file: FileFromAPI;
};

const { file } = Astro.props;

const html = await marked(file.content);
const safeHtml = sanitizeHtml(html);
const truncatedHtml = truncate(safeHtml, 100, {ellipsis: '...'})
---

<Card id=`file-${file.id}` class="file-card">
  <Fragment slot="content">
    <div class="file-meta">
      <span class="file-date">{formatDate(file.date)}</span>
    </div>
    <a href={`/file/${file.id}/`} title={file.title} class="file-title-link">
      <h3 class="file-title">
        {file.title}
      </h3>
    </a>
    <Separator />
    <p class="file-description" set:html={truncatedHtml} />
  </Fragment>
</Card>

<style>
  .file-card {
    position: relative;
    width: 100%;
    max-width: 100%;
    border-radius: var(--border-radius);
    border: 1px solid hsl(var(--border));
    background-color: hsl(var(--card));
  }

  .file-image-container {
    display: none;
    padding: 0;
  }

  @media (min-width: 768px) {
    .file-image-container {
      display: block;
    }
  }

  .file-image {
    height: 120px;
    max-height: 120px;
    width: 100%;
    border-radius: var(--border-radius);
    object-fit: cover;
  }

  @media (min-width: 768px) {
    .file-image {
      height: 240px;
      max-height: none;
    }
  }

  .file-meta {
    display: flex;
    width: 100%;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 0;
  }

  @media (min-width: 768px) {
    .file-meta {
      padding: 0;
    }
  }

  .file-date {
    display: block;
    font-size: 0.875rem;
    color: var(--muted-foreground, #64748b);
  }
  .file-title-link {
    cursor: pointer;
    text-decoration: none;
  }

  .file-title {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
    height: 100%;
    font-family: var(--font-serif);
    transition: text-decoration 0.2s;
    font-weight: 400;
    font-size: 1.5rem;
    line-height: 1.5rem;
    letter-spacing: -0.01562em;
  }

  .file-title:hover {
    text-decoration: underline;
  }

  @media (min-width: 768px) {
    .file-title {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  }

  @media (min-width: 1024px) {
    .file-title {
      -webkit-line-clamp: 2;
    }
  }

  .file-description {
    margin-top: 1rem;
    font-size: 1rem;
    line-height: 1.5;
    color: hsl(var(--muted-foreground));
    margin-bottom: 0;
  }
</style>
